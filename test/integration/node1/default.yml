---
- name: Kong Install
  hosts: test-kitchen

  vars:
    kong_database:         postgres
    kong_version: 0.13.1
    kong_version_current: 0.0.0
    kong_host:  "node1.internal"
    kong_pg_host:          "node0.internal"
    kong_proxy_listen:     "node1.internal:8000"
    kong_proxy_listen_ssl: "node1.internal:8443"
    kong_cluster_listen:   "node1.internal:7946"
    kong_db_update_propagation: 1
    kong_proxy_set_headers:
      "X-Forwarded-Prefix": '$http_x_forwarded_prefix'
    kong_admin_listen:     "0.0.0.0:8001"  # DELETEME PLS (Testing purpose ONLY)

  pre_tasks:
    - name: Kong Migrations
      include_tasks: "roles/ansible-kong/test/integration/node1/kong-migration.yml"
      when: ansible_os_family|lower == 'debian'

  roles:
    - ansible-kong


- name: Kong Objects Configure | v0.13.x and later
  hosts: test-kitchen

  vars:
    kong_version: 0.13.1

  pre_tasks:
    - name: Install jq and curl
      apt: name={{ item }} state=present
      with_items: [ jq, curl ]
      when: ansible_os_family|lower == 'debian'

    - name: Install jq and curl
      yum: name={{ item }} state=present
      with_items: [ jq, curl ]
      when: ansible_os_family|lower == 'redhat'

  roles:
    #*************************#
    #    SERVICES & ROUTES    #
    #*************************#
    #---------------------#
    #   svcOne & Routes   #
    #---------------------#
    - role: ansible-kong            ## ADD service obj for svcOne
      kong_task: service
      kong_service_config:
        name: svcOne
        url: "https://service-upstream.ogonna.com/svcOne/api"
    - role: ansible-kong            ## ADD route obj for svcOne
      kong_task: route
      kong_route_config:
        name: svcOneRoute1
        service: svcOne
        paths: [ "/svcOne" ]
        hosts: [ "og.com", "ab.com" ]
    - role: ansible-kong            ## ADD route obj for svcOne
      kong_task: route
      kong_route_config:
        name: svcOneRoute2
        service: svcOne
        paths: [ "/svcOnePlus" ]
        methods: [ "GET", "POST", "PUT" ]
    #---------------------#
    #   svcTwo & Routes   #
    #---------------------#
    - role: ansible-kong            ## ADD service obj for svcTwo
      kong_task: service
      kong_service_config:
        name: svcTwo
        url: "https://service-upstream.ogonna.com/svc-two"
    - role: ansible-kong            ## ADD route obj for svcTwo
      kong_task: route
      kong_route_config:
        name: svcTwoRoute1
        service: svcTwo
        paths: [ "/svcTwo" ]
    - role: ansible-kong            ## UPDATE service obj for svcTwo
      kong_task: service
      kong_service_config:
        name: svcTwo
        url: "https://service-upstream.ogonna.com/svc-two-new"
    # Note to UPDATE a route = Add new route + delete old route, like below
    - role: ansible-kong            ## ADD REPLACEMENT route obj for svcTwo
      kong_task: route
      kong_route_config:
        name: svcTwoRoute1-new
        service: svcTwo
        paths: [ "/svc-two-updated" ]
        hosts: [ "awe.some.com" ]
    - role: ansible-kong            ## DELETE route obj for svcTwo
      kong_task: route
      kong_route_config:
        name: svcTwoRoute1
        service: svcTwo
        paths: [ "/svcTwo" ]
      kong_delete_route_obj: true  ## DELETE svcTwoRoute1 object
    #-----------------------#
    #   svcThree & Routes   #
    #-----------------------#
    - role: ansible-kong            ## ADD service obj for svcThre
      kong_task: service
      kong_service_config:
        name: svcThree
        url: "https://service-upstream.ogonna.com/service-three"
    - role: ansible-kong            ## ADD route obj for svcThree
      kong_task: route
      kong_route_config:
        name: svcThreeRoute1
        service: svcThree
        paths: [ "/svcThree" ]
    - role: ansible-kong            ## DELETE service obj for svcThree
      kong_task: service
      kong_delete_service_obj: true
      kong_service_config:
        name: svcThree
    #-----------------------#
    #   svcFour & Routes    #
    #-----------------------#
    - role: ansible-kong            ## DELETE service obj for svcThree
      kong_task: service
      kong_delete_service_obj: true
      kong_service_config:
        name: svcFour
    #*************************#
    #   UPSTREAMS & TARGETS   #
    #*************************#
    #--------------------------#
    #   upstreamOne & Targets  #
    #--------------------------#
    - role: ansible-kong            ## ADD upstream obj for upstreamOne
      kong_task: upstream
      kong_upstream_config:
        name: upstreamOne
        slots: 200
    - role: ansible-kong            ## ADD taget obj for upstreamOne
      kong_task: target
      kong_target_config:
        upstream: upstreamOne
        target: targetOne
        weight: 100
    - role: ansible-kong            ## DELETE upstream obj for upstreamOne
      kong_task: upstream
      kong_delete_upstream_obj: true
      kong_upstream_config:
        name: upstreamOne
    #--------------------------#
    #   upstreamTwo & Targets  #
    #--------------------------#
    - role: ansible-kong            ## ADD upstream obj for upstreamTwo
      kong_task: upstream
      kong_upstream_config:
        name: upstreamTwo
        slots: 200
        hash_on: ip
        hash_fallback: header
        hash_on_header: hashHeaderOne
        hash_fallback_header: hashHeaderTwo
        healthchecks:
          active:
            timeout: 10
            concurrency: 5
            http_path: /status
            healthy:
              interval: 3
              http_statuses: [200, 202]
              successes: 3
            unhealthy:
              interval: 5
              http_statuses: [400]
              tcp_failures: 5
              timeouts: 5
              http_failures: 4
          passive:
            healthy:
              http_statuses: [200, 201, 202]
              successes: 3
            unhealthy:
              http_statuses: [500, 503]
              tcp_failures: 3
              timeouts: 5
              http_failures: 6
    - role: ansible-kong            ## ADD taget obj for upstreamTwo
      kong_task: target
      kong_target_config:
        upstream: upstreamTwo
        target: targetTwo
        weight: 100
    #*****************#
    #    CONSUMERS    #
    #*****************#
    - role: ansible-kong            ## ADD consumer obj for consumerOne
      kong_use_old_config_format: false
      kong_task: consumer
      kong_consumer_config:
        username: consumerOne
        custom_id: con-1111
    - role: ansible-kong            ## ADD consumer obj for consumerTwo
      kong_use_old_config_format: false
      kong_task: consumer
      kong_consumer_config:
        username: consumerTwo
        custom_id: con-2222
    - role: ansible-kong            ## ADD consumer obj for consumerThree
      kong_use_old_config_format: false
      kong_task: consumer
      kong_consumer_config:
        username: consumerThree
    - role: ansible-kong            ## UPDATE consumer obj for consumerOne
      kong_use_old_config_format: false
      kong_task: consumer
      kong_consumer_config:
        username: consumerOne
        custom_id: con-1001
    - role: ansible-kong            ## DELETE consumer obj for consumerTwo
      kong_use_old_config_format: false
      kong_task: consumer
      kong_consumer_config:
        username: consumerTwo
      kong_delete_consumer_obj: true
    - role: ansible-kong            ## Update consumer obj for consumerThree with plugin configs
      kong_use_old_config_format: false
      kong_task: consumer
      kong_consumer_config:
        username: consumerThree
        custom_id: con-3333
        plugins:
          - name: acl
            parameters:
              groups: [ svcTwo-user-group ]
          - name: key-auth
            parameters:
              key: "e2f599f74fc4479681e6586a1e644768"
          - name: key-auth
            parameters:
              key: "5750c67b5dc64888aa3b7f08023adb31"
          - name: oauth2
            parameters:
              name: amazing-service
              client_id: AMAZING-CLIENT-ID
              client_secret: AMAZING-CLIENT-SECRET
              redirect_uri: http://amazing-domain/endpoint/
          - name: oauth2
            parameters:
              name: awe-some-service
              client_id: AWESOME-CLIENT-ID
              client_secret: AWESOME-CLIENT-SECRET
              redirect_uri: http://awesome-domain/endpoint/
          - name: basic-auth
            parameters:
              username: smith
              password: bobSecret
          - name: basic-auth
            parameters:
              username: amelia
              password: janeSecret
          - name: hmac-auth
            parameters:
              username: james
          - name: hmac-auth
            parameters:
              username: frodo
              secret:   frodoSecret
          - name: jwt
            parameters:
              key:       "9efdde658a1b4b6e869d57d35dc8d7fb"
              secret:    "1bf8825a9f0e44a0bfb18f7dacf5c43f"
              algorithm: "HS256"
          - name: jwt
            parameters:
              key: "a4221446f5d845f48bd473df8242e08a"
    #****************#
    #    PLUGINS     #
    #****************#
    - role: ansible-kong            ## ADD rate-limiting plugin obj (global)
      kong_task: plugin
      kong_plugin_config:
        name: rate-limiting
        config: { minute: 50, hour: 500 }
    - role: ansible-kong            ## UPDATE rate-limiting plugin obj (global)
      kong_task: plugin
      kong_plugin_config:
        name: rate-limiting
        config: { minute: 100, hour: 500 }
      kong_delete_plugin_obj: false
    - role: ansible-kong            ## ADD rate-limiting plugin obj for svcOneRoute1 route
      kong_task: plugin
      kong_plugin_config:
        name: rate-limiting
        route: svcOneRoute1
        config: { minute: 20, hour: 500 }
    - role: ansible-kong            ## ADD rate-limiting plugin obj for svcOne service and consumerOne consumer
      kong_task: plugin
      kong_plugin_config:
        name: rate-limiting
        service: svcOne
        consumer: consumerOne     # WARNING: consumer obj needs to be created first
        config: { minute: 20, hour: 500 }
      kong_delete_plugin_obj: false
    - role: ansible-kong            ## DELETE rate-limiting plugin obj for svcOne service and consumerOne consumer
      kong_task: plugin
      kong_plugin_config:
        name: rate-limiting
        service: svcOne
        consumer: consumerOne     # WARNING: consumer obj needs to be created first
        config: { minute: 20, hour: 500 }
      kong_delete_plugin_obj: true
    - role: ansible-kong            ## ADD plugin obj for svcOne service
      kong_task: plugin
      kong_plugin_config:
        name: oauth2
        service: svcOne
        config:
          enable_authorization_code: true
          scopes: "email,phone,address"
          mandatory_scope: true
    - role: ansible-kong            ## ADD plugin obj for svcOne service
      kong_task: plugin
      kong_plugin_config:
        name: cors
        service: svcOne
        config:
          origins: "*"
          methods: "GET, POST, PATCH, PUT, DELETE"
          headers: "Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Auth-Token, Access-Control-Allow-Origin, Authorization"
          exposed_headers: "X-Auth-Token"
          credentials: true
          max_age: 3600
    - role: ansible-kong            ## ADD plugin obj for svcOne service and consumerOne consumer
      kong_task: plugin
      kong_plugin_config:
        name: acl
        service: svcOne
        config: { whitelist: "groupOne, groupTwo" }
    - role: ansible-kong            ## ADD plugin obj for svcTwo service
      kong_task: plugin
      kong_plugin_config:
        name: oauth2
        service: svcTwo
        config:
          enable_authorization_code: true
          scopes: "email,phone,address"
          mandatory_scope: true
    - role: ansible-kong            ## ADD plugin obj for svcTwo service
      kong_task: plugin
      kong_plugin_config:
        name: basic-auth
        service: svcTwo
        config: { hide_credentials: true }
    - role: ansible-kong            ## ADD plugin obj for svcTwo service
      kong_task: plugin
      kong_plugin_config:
        name: key-auth
        service: svcTwo
        config: { key_names: X-Api-Key }
    - role: ansible-kong            ## ADD plugin obj for svcTwo service
      kong_task: plugin
      kong_plugin_config:
        name: acl
        service: svcTwo
        config: { whitelist: svcTwo-user-group }
